<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="dashboard.css" />
  <title>CampusFresh | Dashboard</title>
</head>
<body>
  <div class="wrapper">
    <!-- Top Navigation -->
    <nav class="nav">
      <div class="nav-logo"><p>CampusFresh</p></div>
      <div class="nav-menu" id="navMenu">
        <ul>
          <li><a href="#" class="link active">Dashboard</a></li>
          <li><a href="list.html" class="link">My Orders</a></li>
        </ul>
      </div>
      <div class="nav-button">
        <button class="btn logout-btn" onclick="logout()">Logout</button>
      </div>
      <div class="nav-menu-btn">
        <i class="bx bx-menu" onclick="toggleMenu()"></i>
      </div>
    </nav>

    <!-- Main Dashboard -->
    <div class="main-content-area">
      <header class="page-header">
        <h1 class="welcome-text">
          Welcome back, <span id="firstname" class="highlight-name">User</span>!
        </h1>

        <!-- Hostel Selector -->
        <div class="hostel-selector">
          <label for="hostelSelect"><strong>Select Hostel:</strong></label>
          <select id="hostelSelect">
            <option value="">-- Choose Hostel --</option>
            <option value="PI-A">PI-A</option>
            <option value="PI-B">PI-B</option>
            <option value="PI-C">PI-C</option>
            <option value="IBN-A">IBN-A</option>
            <option value="IBN-B">IBN-B</option>
            <option value="IBN-C">IBN-C</option>
            <option value="NGH-A">NGH-A</option>
            <option value="NGH-B">NGH-B</option>
            <option value="VASCO">VASCO</option>
          </select>
        </div>

        <p class="current-hostel">
          Your current hostel: <span id="currentHostel">Not Selected</span>
        </p>
      </header>

      <!-- Dashboard Cards -->
      <div class="dashboard-grid">
        <!-- Quick Actions -->
        <div class="card quick-actions-card">
          <div class="card-content">
            <h3 class="card-title">Ready to submit your laundry?</h3>
            <p id="pickup-days-text">Please select your hostel to view pickup days.</p>
          </div>
          <div class="action-buttons">
            <a href="list.html" class="action-btn primary-btn">+ Submit New Laundry</a>
            <button class="action-btn secondary-btn raise-btn" id="raiseComplaintBtn">Raise Complaint</button>
          </div>
        </div>

        <!-- Active Laundry Status -->
        <div class="card status-card">
          <div class="card-header">
            <i class="bx bx-loader-circle status-icon"></i> 
            <h3 class="card-title">Active Submission Status</h3>
          </div>
          <p><strong>Items:</strong> <span id="active-items-count">--</span></p>
          <p><strong>Status:</strong> <span id="active-status-text">--</span></p>
          <p><strong>Last Updated:</strong> <span id="active-status-date">--</span></p>
        </div>

        <!-- Recent Updates -->
        <div class="card notifications-card">
          <h3 class="card-title">History</h3>
          <ul id="submission-history-list" class="notification-list"></ul>
          <a href="#" class="view-all">View all ‚Üí</a>
        </div>

        <!-- Pickup Schedule -->
        <div class="card schedule-card">
          <div class="card-header">
            <i class='bx bxs-calendar-event status-icon'></i>
            <h3 class="card-title">Next Pickup</h3>
          </div>
          <p class="schedule-detail"><strong>Days:</strong> <span id="schedule-days">--</span></p>
          <p class="schedule-detail"><strong>Time:</strong> <span class="time-highlight">3 PM ‚Äì 6 PM</span></p>
          <p class="contact-info">Contact: +91 XXXXXXXX</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Complaint Modal -->
  <!-- Complaint Modal -->
<div id="complaintModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h2>Raise a Complaint</h2>
    <form id="complaintForm">
      <input type="text" id="complaintSubject" placeholder="Enter Subject" required>
      <textarea id="complaintMessage" placeholder="Describe your issue..." required></textarea>
      <button type="submit" class="submit-btn">Submit Complaint</button>
    </form>
  </div>
</div>


  <!-- Footer -->
  <footer>
    <div class="container footer-grid">
      <div class="footer-column brand-info">
        <div class="logo-group"><span class="brand-name">CampusFresh</span></div>
        <p class="tagline-footer">Laundry, done the smart way‚Äîjust for your college.</p>
        <p class="copyright">&copy; 2025 CampusFresh. All rights reserved.</p>
      </div>

      <div class="footer-column contact-info">
        <h3>Get in Touch</h3>
        <ul>
          <li>Phone: <a href="tel:7947889898">7947889898</a></li>
          <li>Email: <a href="mailto:support@campusfresh.com">support@campusfresh.com</a></li>
          <li>Campus Support Office</li>
        </ul>
      </div>

      <div class="footer-column schedule-info">
        <h3>Pickup Schedule</h3>
        <ul class="schedule-list">
          <li><span>Mon & Thu:</span> PI-A, IBN-A, NGH-A</li>
          <li><span>Tue & Fri:</span> PI-B, IBN-B, NGH-B</li>
          <li><span>Wed & Sat:</span> PI-C, IBN-C, VASCO</li>
        </ul>
      </div>
    </div>
  </footer>

  <!-- Script -->
<script>
const hostelDays = {
  "PI-A": "Mon & Thu",
  "IBN-A": "Mon & Thu",
  "NGH-A": "Mon & Thu",
  "PI-B": "Tue & Fri",
  "IBN-B": "Tue & Fri",
  "NGH-B": "Tue & Fri",
  "PI-C": "Wed & Sat",
  "IBN-C": "Wed & Sat",
  "VASCO": "Wed & Sat"
};

function toggleMenu() {
  const menu = document.getElementById("navMenu");
  const icon = document.querySelector(".nav-menu-btn i");
  const isOpen = menu.classList.toggle("responsive");
  icon.className = isOpen ? "bx bx-x" : "bx bx-menu";
}

function logout() {
  localStorage.clear();
  alert("Logging out...");
  window.location.href = "login.html";
}

function updateSchedule(hostel) {
  const days = hostelDays[hostel] || "--";
  document.getElementById("schedule-days").textContent = days;
  document.getElementById("pickup-days-text").textContent =
    days !== "--"
      ? `Laundry pickup for ${hostel} is on ${days}, 3 PM ‚Äì 6 PM.`
      : "Please select your hostel.";
}

// ‚úÖ Load dashboard data
async function loadDashboard(email) {
  try {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Session expired, please log in again.");
      window.location.href = "login.html";
      return;
    }

    const res = await fetch(`/laundry/dashboard?email=${encodeURIComponent(email)}`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    if (!res.ok) {
      console.error("Dashboard fetch failed:", res.status);
      return;
    }

    const data = await res.json();
    const { user, activeOrder, history } = data;

    document.getElementById("firstname").textContent = user.firstname || "User";
    document.getElementById("currentHostel").textContent = user.hostel || "Not Selected";
    document.getElementById("hostelSelect").value = user.hostel || "";
    localStorage.setItem("hostel", user.hostel || "");
    updateSchedule(user.hostel);

    const activeItems = activeOrder?.totalItems || (activeOrder?.items?.length ?? 0);
    document.getElementById("active-items-count").textContent = activeItems || "--";
    document.getElementById("active-status-text").textContent =
      activeOrder?.status || "No Active Order";
    document.getElementById("active-status-date").textContent =
      activeOrder?.createdAt ? new Date(activeOrder.createdAt).toLocaleString() : "--";

    const historyList = document.getElementById("submission-history-list");
    historyList.innerHTML = "";
    if (history && history.length > 0) {
      history.slice(0, 5).forEach(order => {
        const date = new Date(order.createdAt).toLocaleDateString();
        const li = document.createElement("li");
        li.textContent = `${date} - ${order.status} (${order.totalItems} items)`;
        historyList.appendChild(li);
      });
    } else {
      const li = document.createElement("li");
      li.textContent = "No previous laundry submissions found.";
      historyList.appendChild(li);
    }
  } catch (err) {
    console.error("Dashboard load failed:", err);
  }
}

// ‚úÖ Handle hostel change
document.getElementById("hostelSelect").addEventListener("change", async (e) => {
  const selected = e.target.value;
  if (!selected) return;

  const email = localStorage.getItem("userEmail");
  const token = localStorage.getItem("token");

  if (!email || !token) {
    alert("Please log in again.");
    window.location.href = "login.html";
    return;
  }

  localStorage.setItem("hostel", selected);
  document.getElementById("currentHostel").textContent = selected;
  updateSchedule(selected);

  try {
    const res = await fetch("/laundry/updateHostel", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ email, hostel: selected }),
    });

    if (res.ok) {
      console.log("‚úÖ Hostel updated successfully");
      loadDashboard(email);
    } else {
      console.error("‚ùå Failed to update hostel:", res.status);
    }
  } catch (err) {
    console.error("Error updating hostel:", err);
  }
});

// ‚úÖ View all history
document.querySelector(".view-all").addEventListener("click", async (e) => {
  e.preventDefault();

  const token = localStorage.getItem("token");
  const email = localStorage.getItem("userEmail");
  if (!token || !email) {
    alert("Login required.");
    window.location.href = "login.html";
    return;
  }

  const historyList = document.getElementById("submission-history-list");
  historyList.innerHTML = "<li>Loading all orders...</li>";

  try {
    const res = await fetch(`/laundry/my-orders/${encodeURIComponent(email)}`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const data = await res.json();
    const orders = data.history || [];
    historyList.innerHTML = "";

    if (orders.length === 0) {
      historyList.innerHTML = "<li>No orders found.</li>";
      return;
    }

    orders.forEach(order => {
      const date = new Date(order.createdAt).toLocaleString();
      const li = document.createElement("li");
      li.innerHTML = `
        <h4>üß∫ ${date}</h4>
        <p>Status: <strong>${order.status}</strong></p>
        <p>Hostel: ${order.hostel}</p>
        <p>Total Items: ${order.totalItems}</p>
        <ul>${(order.items || []).map(i => `<li>${i.name} ‚Äî ${i.quantity}</li>`).join('')}</ul>
        <hr/>
      `;
      historyList.appendChild(li);
    });

    document.querySelector(".view-all").style.display = "none";
  } catch (err) {
    console.error("Error loading orders:", err);
    historyList.innerHTML = "<li>Error loading orders. Try again later.</li>";
  }
});

// ‚úÖ On DOM load
window.addEventListener("DOMContentLoaded", () => {
  const name = localStorage.getItem("firstname");
  const email = localStorage.getItem("userEmail");
  const hostel = localStorage.getItem("hostel");

  if (!email) {
    alert("Login required.");
    window.location.href = "login.html";
    return;
  }

  if (name) document.getElementById("firstname").textContent = name;
  if (hostel) {
    document.getElementById("currentHostel").textContent = hostel;
    document.getElementById("hostelSelect").value = hostel;
    updateSchedule(hostel);
  }

  loadDashboard(email);
});

// ==========================
// ‚úÖ COMPLAINT POPUP SECTION
// ==========================

const raiseComplaintBtn = document.getElementById("raiseComplaintBtn");
const complaintModal = document.getElementById("complaintModal");
const closeModal = document.getElementById("closeModal");
const complaintForm = document.getElementById("complaintForm");

// Open modal
raiseComplaintBtn.addEventListener("click", () => {
  complaintModal.style.display = "flex";
  complaintModal.classList.add("fade-in");
  document.body.style.overflow = "hidden";
});

// Close modal
closeModal.addEventListener("click", closeComplaintModal);
window.addEventListener("click", (e) => {
  if (e.target === complaintModal) closeComplaintModal();
});

function closeComplaintModal() {
  complaintModal.classList.remove("fade-in");
  complaintModal.classList.add("fade-out");
  setTimeout(() => {
    complaintModal.style.display = "none";
    complaintModal.classList.remove("fade-out");
    document.body.style.overflow = "auto";
  }, 250);
}

// ‚úÖ Complaint form submission
complaintForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const token = localStorage.getItem("token");
  const email = localStorage.getItem("userEmail");
  const subject = document.getElementById("complaintSubject").value.trim();
  const message = document.getElementById("complaintMessage").value.trim();

  if (!subject || !message) return alert("‚ö†Ô∏è Please fill in all fields.");

  try {
    const res = await fetch("http://localhost:2000/complaints/raise", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ email, subject, message }),
    });

    const data = await res.json();
    if (res.ok) {
      alert("‚úÖ Complaint submitted successfully!");
      complaintForm.reset();
      closeComplaintModal();
    } else {
      alert(`‚ùå ${data.message || "Failed to submit complaint."}`);
    }
  } catch (error) {
    alert("üö® Server error. Please try again later.");
    console.error("Complaint Error:", error);
  }
});

</script>


</body>
</html>
